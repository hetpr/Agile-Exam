name: Complete Testing and Monitoring Automation

on:
  push:
    branches: [ main, '**' ]
  pull_request:
    branches: [ main, '**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (produce JUnit XML)
        id: pytest
        run: |
          set -o pipefail
          pytest -q --junitxml=report.xml
        continue-on-error: true

      - name: Upload test report artifact
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: report.xml

      - name: Post Slack notification with test summary
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET
          import json, os, sys, requests

          webhook = os.environ.get('SLACK_WEBHOOK')
          if not webhook:
              print("No SLACK_WEBHOOK set; skipping Slack notification.")
              sys.exit(0)

          # read junit file
          try:
              tree = ET.parse('report.xml')
              root = tree.getroot()
          except Exception as e:
              print("Could not parse report.xml:", e)
              payload = {"text": "CI Test Report - _No report generated_ (parsing failed)."}
              requests.post(webhook, json=payload)
              sys.exit(0)

          # Find suite attributes (pytest produces <testsuites><testsuite ...>)
          suite = root.find('testsuite') if root.tag == 'testsuites' else root
          tests = int(suite.attrib.get('tests', '0'))
          failures = int(suite.attrib.get('failures', '0'))
          errors = int(suite.attrib.get('errors', '0'))
          skipped = int(suite.attrib.get('skipped', '0'))
          time = suite.attrib.get('time', '0')

          status = "SUCCESS" if (failures == 0 and errors == 0) else "FAILURE"
          color = "#36a64f" if status == "SUCCESS" else "#FF0000"

          text = f"CI Test Report - *{status}*\\nTests: {tests} | Failures: {failures} | Errors: {errors} | Skipped: {skipped} | Duration: {time}s"

          payload = {
              "text": text,
              "attachments": [
                  {
                      "color": color,
                      "fields": [
                          {"title": "Total tests", "value": str(tests), "short": True},
                          {"title": "Failures", "value": str(failures), "short": True},
                          {"title": "Errors", "value": str(errors), "short": True},
                          {"title": "Skipped", "value": str(skipped), "short": True},
                          {"title": "Duration (s)", "value": str(time), "short": True}
                      ]
                  }
              ]
          }
          r = requests.post(webhook, json=payload)
          print("Slack response status:", r.status_code, r.text)
          if r.status_code >= 400:
              sys.exit(1)
          PY